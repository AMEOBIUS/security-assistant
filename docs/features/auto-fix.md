# Auto-Fix Feature

**Status:** Session 78 (Part 1) - 80% Complete  
**Version:** v1.5.0 (Planned)

---

## Overview

Auto-Fix automatically generates and applies security fixes using LLM intelligence. It can create GitLab Merge Requests with AI-generated code fixes, explanations, and professional descriptions.

---

## Features

- **LLM-Powered Fix Generation:** Context-aware code fixes using NVIDIA NIM, OpenAI, or Anthropic
- **Multiple Strategies:** Safe, Aggressive, or Minimal fix approaches
- **GitLab Integration:** Automatic MR creation with professional descriptions
- **Dry-Run Mode:** Preview fixes before applying
- **Smart Commit Messages:** Includes finding metadata and explanations

---

## Usage

### Basic Usage

```bash
# Preview fix (dry-run)
security-assistant auto-fix BANDIT-B201 --dry-run

# Apply fix locally
security-assistant auto-fix BANDIT-B201

# Create GitLab MR with fix
security-assistant auto-fix BANDIT-B201 --create-mr
```

### Fix Strategies

```bash
# Safe (default) - Conservative, minimal changes
security-assistant auto-fix BANDIT-B201 --strategy safe

# Aggressive - Complete refactor if needed
security-assistant auto-fix BANDIT-B201 --strategy aggressive --create-mr

# Minimal - Smallest possible change
security-assistant auto-fix BANDIT-B201 --strategy minimal
```

### Advanced Options

```bash
# Custom report path
security-assistant auto-fix BANDIT-B201 \
  --report custom-scan.json \
  --create-mr

# With custom config
security-assistant auto-fix BANDIT-B201 \
  --config security-assistant.yaml \
  --strategy aggressive \
  --create-mr

# Verbose output
security-assistant auto-fix BANDIT-B201 \
  --create-mr \
  --verbose
```

---

## Fix Strategies Comparison

| Strategy | Changes | Risk | Use Case |
|----------|---------|------|----------|
| **Safe** | Minimal, conservative | Low | Production code, critical systems |
| **Aggressive** | Complete refactor | Medium | Technical debt, modernization |
| **Minimal** | Smallest possible | Very Low | Quick fixes, hotfixes |

---

## Requirements

### LLM Configuration

Auto-fix requires an LLM provider. Configure via environment variables:

```bash
# NVIDIA NIM (recommended)
export SA_LLM__PROVIDER=nvidia
export SA_LLM__API_KEY=your-nvidia-api-key
export SA_LLM__MODEL=mistralai/devstral-2-123b-instruct-2512

# OpenAI
export SA_LLM__PROVIDER=openai
export SA_LLM__API_KEY=your-openai-api-key
export SA_LLM__MODEL=gpt-4

# Anthropic
export SA_LLM__PROVIDER=anthropic
export SA_LLM__API_KEY=your-anthropic-api-key
export SA_LLM__MODEL=claude-3-5-sonnet-20240620
```

### GitLab Integration

For MR creation, install `glab` CLI:

```bash
# macOS
brew install glab

# Linux
sudo snap install glab

# Windows
scoop install glab
```

Authenticate:
```bash
glab auth login
```

---

## Workflow

### 1. Scan Project

```bash
security-assistant scan . --format json
```

### 2. Review Findings

```bash
# List findings
cat security-reports/scan-results.json | jq '.results[].findings[] | {id, title, severity}'
```

### 3. Preview Fix

```bash
security-assistant auto-fix BANDIT-B201 --dry-run
```

Output:
```
Generating fix for: SQL Injection via string formatting
File: app.py:10
Severity: HIGH
Strategy: safe

Fix generated!

==================================================
EXPLANATION:
==================================================
Replaced string formatting with parameterized query to prevent SQL injection attacks.
==================================================

[DRY RUN] Fix preview:
==================================================
# Fixed SQL injection vulnerability
query = "SELECT * FROM users WHERE id=?"
cursor.execute(query, (user_id,))
==================================================

[DRY RUN] No changes made. Use --create-mr to apply fix.
```

### 4. Create MR

```bash
security-assistant auto-fix BANDIT-B201 --create-mr
```

Output:
```
Generating fix for: SQL Injection via string formatting
...
Creating GitLab MR...
MR created: https://gitlab.com/namespace/project/-/merge_requests/42
```

### 5. Review & Merge

1. Open MR in GitLab
2. Review code changes
3. Check CI/CD pipeline
4. Merge when ready

---

## MR Description Template

Auto-generated MRs include:

```markdown
## üîí Security Fix: SQL Injection via string formatting

**Severity:** HIGH  
**Scanner:** bandit  
**Category:** SQL Injection  
**File:** `app.py:10`

### üìã Vulnerability Description

User input directly in SQL query

### üõ†Ô∏è Fix Applied

Replaced string formatting with parameterized query to prevent SQL injection attacks.

### ‚úÖ Checklist

- [ ] Code review completed
- [ ] Tests passing
- [ ] No functionality broken
- [ ] Security verified

---

ü§ñ *This MR was automatically generated by Security Assistant*  
Finding ID: `BANDIT-B201`
```

---

## Best Practices

### 1. Always Dry-Run First

```bash
# Preview before applying
security-assistant auto-fix FINDING-ID --dry-run
```

### 2. Use Safe Strategy for Production

```bash
# Conservative fixes for critical code
security-assistant auto-fix FINDING-ID --strategy safe --create-mr
```

### 3. Review Generated Code

- Check for logic errors
- Verify functionality preserved
- Run tests locally
- Review MR diff carefully

### 4. Test Before Merging

```bash
# After MR created, checkout branch
git fetch origin
git checkout security-fix/bandit-b201

# Run tests
pytest

# Manual testing
python app.py
```

### 5. Batch Similar Fixes

For multiple similar findings, fix them in separate MRs for easier review.

---

## Troubleshooting

### LLM Not Available

```
ERROR: LLM service not available. Configure SA_LLM__* environment variables.
```

**Solution:** Configure LLM provider (see Requirements section)

### Finding Not Found

```
ERROR: Finding not found: BANDIT-B201
```

**Solution:** Check finding ID in scan results:
```bash
cat security-reports/scan-results.json | jq '.results[].findings[].id'
```

### Git/GitLab Errors

```
ERROR: Failed to create MR: ...
```

**Solutions:**
- Ensure `glab` is installed and authenticated
- Check git remote is GitLab
- Verify write permissions to repository

### Invalid LLM Response

```
ERROR: Invalid LLM response format
```

**Solution:** Try different strategy or re-run (LLM responses can vary)

---

## Limitations

### Current (Session 78)

- Single finding per command
- No test generation (coming in Session 79)
- No batch fixes (coming in Session 79)
- GitLab only (GitHub support planned)

### Planned (Session 79)

- ‚úÖ Test generation for fixes
- ‚úÖ Batch fix support
- ‚úÖ Review workflow
- ‚úÖ Enhanced documentation

---

## Examples

### Example 1: SQL Injection Fix

**Finding:**
```python
# Vulnerable code
query = f"SELECT * FROM users WHERE id={user_id}"
cursor.execute(query)
```

**Fix (Safe Strategy):**
```python
# Fixed SQL injection vulnerability
query = "SELECT * FROM users WHERE id=?"
cursor.execute(query, (user_id,))
```

### Example 2: XSS Fix

**Finding:**
```python
# Vulnerable code
return f"<h1>Welcome {username}</h1>"
```

**Fix (Safe Strategy):**
```python
# Fixed XSS vulnerability
from html import escape
return f"<h1>Welcome {escape(username)}</h1>"
```

### Example 3: Path Traversal Fix

**Finding:**
```python
# Vulnerable code
file_path = f"/uploads/{filename}"
with open(file_path) as f:
    return f.read()
```

**Fix (Safe Strategy):**
```python
# Fixed path traversal vulnerability
from pathlib import Path
safe_path = Path("/uploads") / Path(filename).name
with open(safe_path) as f:
    return f.read()
```

---

## API Reference

### FixGenerator

```python
from security_assistant.services.fix_generator import FixGenerator, FixStrategy

generator = FixGenerator(llm_service)

# Generate fix
fixed_code, explanation = await generator.generate_fix(
    finding,
    strategy=FixStrategy.SAFE
)
```

### GitLabMRCreator

```python
from security_assistant.integrations.gitlab_mr_creator import GitLabMRCreator

creator = GitLabMRCreator()

# Create MR
mr_url = await creator.create_fix_mr(
    finding,
    fixed_code,
    explanation,
    dry_run=False
)
```

---

## Contributing

Session 78 is 80% complete. Remaining work:

1. CLI integration (30 min)
2. Manual testing (1 hour)
3. Documentation polish (30 min)

See `docs/sessions/SESSION_78_PROGRESS.md` for details.

---

**Last Updated:** 2025-12-10  
**Session:** 78 (Part 1)  
**Status:** In Progress
