name: Security Scan (No SARIF)

# –≠—Ç–æ—Ç workflow –¥–ª—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –ë–ï–ó GitHub Advanced Security
# –í—Å–µ –æ—Ç—á–µ—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –∫ PR

on:
  pull_request:
    branches:
      - main
      - master
      - develop
  push:
    branches:
      - main
      - master
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      scan_target:
        description: 'Directory to scan'
        required: false
        default: '.'
      enable_bandit:
        description: 'Enable Bandit scanner'
        required: false
        default: 'true'
      enable_semgrep:
        description: 'Enable Semgrep scanner'
        required: false
        default: 'true'
      enable_trivy:
        description: 'Enable Trivy scanner'
        required: false
        default: 'true'
      fail_on_critical:
        description: 'Fail on critical findings'
        required: false
        default: 'true'
      fail_on_high:
        description: 'Fail on high findings'
        required: false
        default: 'false'
      high_threshold:
        description: 'Maximum allowed HIGH findings (0 = fail on any)'
        required: false
        default: '10'

env:
  ENABLE_BANDIT: ${{ github.event.inputs.enable_bandit || 'true' }}
  ENABLE_SEMGREP: ${{ github.event.inputs.enable_semgrep || 'true' }}
  ENABLE_TRIVY: ${{ github.event.inputs.enable_trivy || 'true' }}
  DEDUP_STRATEGY: 'both'
  PRIORITY_THRESHOLD: '70'
  MAX_ISSUES: '10'
  SCAN_TARGET: ${{ github.event.inputs.scan_target || '.' }}
  FAIL_ON_HIGH: ${{ github.event.inputs.fail_on_high || 'false' }}
  FAIL_ON_CRITICAL: ${{ github.event.inputs.fail_on_critical || 'true' }}
  HIGH_THRESHOLD: ${{ github.event.inputs.high_threshold || '10' }}

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install Bandit
        if: env.ENABLE_BANDIT == 'true'
        run: pip install bandit[toml]
      
      - name: Install Semgrep
        if: env.ENABLE_SEMGREP == 'true'
        run: pip install semgrep
      
      - name: Install Trivy
        if: env.ENABLE_TRIVY == 'true'
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy
      
      - name: Create reports directory
        run: mkdir -p security-reports
      
      - name: Run security scan
        id: scan
        run: |
          python -c "
          from security_assistant.orchestrator import ScanOrchestrator, ScannerType
          from security_assistant.scanners.bandit_scanner import BanditScanner
          from security_assistant.scanners.semgrep_scanner import SemgrepScanner
          from security_assistant.scanners.trivy_scanner import TrivyScanner
          import json
          import os
          
          # Initialize orchestrator
          orchestrator = ScanOrchestrator(
              dedup_strategy=os.getenv('DEDUP_STRATEGY', 'both'),
              max_workers=3
          )
          
          # Enable scanners based on configuration
          if os.getenv('ENABLE_BANDIT') == 'true':
              print('Enabling Bandit scanner...')
              orchestrator.enable_scanner(ScannerType.BANDIT, BanditScanner())
          
          if os.getenv('ENABLE_SEMGREP') == 'true':
              print('Enabling Semgrep scanner...')
              orchestrator.enable_scanner(ScannerType.SEMGREP, SemgrepScanner())
          
          if os.getenv('ENABLE_TRIVY') == 'true':
              print('Enabling Trivy scanner...')
              orchestrator.enable_scanner(ScannerType.TRIVY, TrivyScanner())
          
          # Run scan
          scan_target = os.getenv('SCAN_TARGET', '.')
          print(f'Scanning: {scan_target}')
          result = orchestrator.scan_directory(scan_target)
          
          # Save results
          results_data = {
              'total_findings': len(result.all_findings),
              'deduplicated_findings': len(result.deduplicated_findings),
              'execution_time': result.execution_time_seconds,
              'findings_by_severity': {k.value: v for k, v in result.findings_by_severity.items()},
              'findings_by_scanner': {k.value: v for k, v in result.findings_by_scanner.items()},
              'findings': [
                  {
                      'id': f.finding_id,
                      'scanner': f.scanner.value,
                      'severity': f.severity.value,
                      'category': f.category,
                      'file': f.file_path,
                      'line_start': f.line_start,
                      'line_end': f.line_end,
                      'title': f.title,
                      'description': f.description,
                      'priority_score': f.priority_score,
                      'cwe_ids': f.cwe_ids,
                      'owasp_categories': f.owasp_categories
                  }
                  for f in result.deduplicated_findings
              ]
          }
          
          with open('security-reports/scan-results.json', 'w') as f:
              json.dump(results_data, f, indent=2)
          
          print(f'‚úÖ Scan complete: {len(result.deduplicated_findings)} findings')
          print(f'Execution time: {result.execution_time_seconds:.2f}s')
          print(f'Findings by severity: {result.findings_by_severity}')
          
          # Set outputs for GitHub Actions
          with open(os.getenv('GITHUB_OUTPUT'), 'a') as f:
              f.write(f'total_findings={len(result.deduplicated_findings)}\\n')
              f.write(f'critical_count={result.findings_by_severity.get(\"CRITICAL\", 0)}\\n')
              f.write(f'high_count={result.findings_by_severity.get(\"HIGH\", 0)}\\n')
              f.write(f'medium_count={result.findings_by_severity.get(\"MEDIUM\", 0)}\\n')
              f.write(f'low_count={result.findings_by_severity.get(\"LOW\", 0)}\\n')
          "
      
      - name: Generate Markdown summary
        if: always()
        run: |
          python -c "
          import json
          
          with open('security-reports/scan-results.json', 'r') as f:
              results = json.load(f)
          
          summary = '# üîí Security Scan Results\n\n'
          summary += f'**Total Findings:** {results[\"deduplicated_findings\"]}\n\n'
          summary += '## Severity Breakdown\n\n'
          summary += '| Severity | Count |\n'
          summary += '|----------|-------|\n'
          
          severity_emoji = {
              'CRITICAL': 'üî¥',
              'HIGH': 'üü†',
              'MEDIUM': 'üü°',
              'LOW': 'üü¢',
              'INFO': 'üîµ'
          }
          
          for severity in ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO']:
              count = results['findings_by_severity'].get(severity, 0)
              emoji = severity_emoji.get(severity, '‚ö™')
              summary += f'| {emoji} {severity} | {count} |\n'
          
          summary += '\n## Scanners\n\n'
          for scanner, count in results['findings_by_scanner'].items():
              summary += f'- **{scanner}**: {count} findings\n'
          
          summary += f'\n**Execution Time:** {results[\"execution_time\"]:.2f}s\n'
          
          with open('security-reports/SUMMARY.md', 'w') as f:
              f.write(summary)
          
          print('‚úÖ Markdown summary generated')
          "
      
      - name: Upload reports as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: security-reports/
          retention-days: 30
      
      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            
            // Read summary
            const summary = fs.readFileSync('security-reports/SUMMARY.md', 'utf8');
            
            // Read full results
            const results = JSON.parse(fs.readFileSync('security-reports/scan-results.json', 'utf8'));
            
            let comment = summary + '\n\n';
            
            if (results.findings.length > 0) {
              comment += '## Top Priority Findings\n\n';
              const topFindings = results.findings
                .sort((a, b) => b.priority_score - a.priority_score)
                .slice(0, 5);
              
              const severityEmoji = {
                'CRITICAL': 'üî¥',
                'HIGH': 'üü†',
                'MEDIUM': 'üü°',
                'LOW': 'üü¢',
                'INFO': 'üîµ'
              };
              
              for (const finding of topFindings) {
                comment += `### ${severityEmoji[finding.severity]} ${finding.title}\n`;
                comment += `- **File:** \`${finding.file}:${finding.line_start}\`\n`;
                comment += `- **Priority:** ${finding.priority_score.toFixed(0)}/100\n`;
                comment += `- **Scanner:** ${finding.scanner}\n`;
                comment += `- **Category:** ${finding.category}\n\n`;
              }
            }
            
            comment += '\n---\n';
            comment += `üìä [Download full reports](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;
            comment += 'üìÑ Reports include: JSON, SARIF, HTML\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Check severity thresholds
        if: always()
        run: |
          python -c "
          import json
          import sys
          import os
          
          with open('security-reports/scan-results.json', 'r') as f:
              results = json.load(f)
          
          critical_count = results['findings_by_severity'].get('CRITICAL', 0)
          high_count = results['findings_by_severity'].get('HIGH', 0)
          high_threshold = int(os.getenv('HIGH_THRESHOLD', '10'))
          
          print(f'Critical findings: {critical_count}')
          print(f'High findings: {high_count} (threshold: {high_threshold})')
          
          # Check CRITICAL
          if os.getenv('FAIL_ON_CRITICAL') == 'true' and critical_count > 0:
              print('‚ùå Pipeline failed: Critical severity findings detected')
              sys.exit(1)
          
          # Check HIGH with threshold
          if os.getenv('FAIL_ON_HIGH') == 'true':
              if high_threshold == 0 and high_count > 0:
                  print('‚ùå Pipeline failed: High severity findings detected (strict mode)')
                  sys.exit(1)
              elif high_count > high_threshold:
                  print(f'‚ùå Pipeline failed: High findings ({high_count}) exceed threshold ({high_threshold})')
                  sys.exit(1)
              else:
                  print(f'‚ö†Ô∏è  High findings within threshold: {high_count}/{high_threshold}')
          
          print('‚úÖ No blocking findings detected')
          "
